# CORP 项目深度学习手册（第四册）
> 主题：参数标定与实盘部署手册（含监控告警与故障演练）
> 代码库：`<PROJECT_ROOT>/corp`
> 目标：把“能跑回测”升级为“能上线、能值守、能回滚、能持续优化”

---

## 0. 阅读方式与使用场景

第四册的定位不是“再讲一遍模型”，而是把第三册的策略-风控联合推导，变成生产系统里的可执行流程。

你将获得三类能力：
1. 参数标定能力：知道每个参数从哪里来、如何估、何时重估、如何防过拟合。
2. 部署运维能力：知道服务如何上线、如何灰度、如何回滚、如何做变更门禁。
3. 运行保障能力：知道如何监控、告警、应急处置与故障演练。

建议阅读顺序：
1. 先读第 1-4 章（参数体系与数学标定框架）。
2. 再读第 5-8 章（工程部署与运行控制）。
3. 最后执行第 9-12 章（监控、演练、巡检、复盘模板）。

---

## 1. 参数体系全景：从理论参数到生产参数

### 1.1 参数分层模型

把项目参数分成四层：
1. 市场结构层：\(\sigma, k, \lambda\) 等成交与波动相关参数。
2. 策略控制层：`base_spread_bps`、`gamma`、`inventory_limit`、`inventory_skew_factor`。
3. 风控约束层：`daily_loss_limit_pct`、`max_drawdown_pct`、`position_concentration_limit`。
4. 运行工程层：缓存 TTL、超时阈值、重连间隔、告警阈值、资源限额。

第四册核心观点：
- 生产问题的多数根因不在单个参数，而在“跨层参数耦合不一致”。

### 1.2 代码映射总表

参数主要落点：
1. 策略层参数：
- `strategies/market_making/avellaneda_stoikov.py:ASConfig`
- `strategies/market_making/integrated_strategy.py:IntegratedStrategyConfig`
- `strategies/market_making/fast_integrated_strategy.py:FastIntegratedStrategyConfig`
- `strategies/market_making/hawkes_mm.py:HawkesMMConfig`（Hawkes 过程做市策略）

2. 风控层参数：
- `research/risk/circuit_breaker.py:CircuitBreakerConfig`
- `research/hedging/adaptive_delta.py:AdaptiveHedgeConfig`
- `research/signals/regime_detector.py:RegimeConfig`
- `research/signals/fast_regime_detector.py:FastRegimeConfig`

3. 部署环境参数：
- `config/settings.py:Settings`
- `deployment/config/.env.prod.template`
- `deployment/docker-compose.prod.yml`
- `deployment/k8s/trading-engine.yaml`

### 1.3 参数生命周期

每个参数都应有以下元数据：
1. 来源：理论推导、统计估计、经验默认。
2. 生效范围：研究、仿真、预生产、生产。
3. 更新频率：实时、日更、周更、月更。
4. 风险级别：变更后对资金风险和系统稳定性的影响。
5. 回滚策略：失败时恢复到哪个版本。

建议将参数当做版本化资产，不当做“代码常量”。

---

## 2. 策略参数标定：数学框架与工程落地

## 2.1 目标函数回顾

单周期可写成：
\[
J(\theta)=\mathbb{E}[R^{spread}(\theta)]
-\lambda_q\mathbb{E}[q_t^2]
-\lambda_{tail}\mathrm{CVaR}_{\alpha}(\theta)
-\lambda_c\mathbb{E}[C_{txn}(\theta)]
\]
其中 \(\theta\) 代表策略参数向量，如：
\[
\theta=(\gamma,\text{base\_spread\_bps},\text{inventory\_limit},\text{skew\_factor})
\]

### 2.2 \(\gamma\)（风险厌恶）标定

在 AS 框架下，保留价偏移：
\[
\Delta r = q\gamma\sigma^2\tau
\]

若你希望库存在上限 \(Q\) 时，报价中心最大偏移不超过 \(\eta S\)：
\[
Q\gamma\sigma^2\tau \le \eta S
\Rightarrow
\gamma \le \frac{\eta S}{Q\sigma^2\tau}
\]

可把这个上界当“风险安全边界”，再在边界内做回测寻优。

代码对齐：
- `strategies/market_making/avellaneda_stoikov.py:quote`
- `strategies/market_making/integrated_strategy.py::_calculate_reservation_price`

### 2.3 `base_spread_bps` 标定

设成交强度近似：
\[
\lambda(\delta)=A e^{-k\delta}
\]

单边期望收益（忽略高阶项）可近似为：
\[
\Pi(\delta)=\delta\lambda(\delta)-\text{adverse}(\delta)
\]

实务上可用离线回归估计 `adverse(δ)` 并数值求 \(\delta^*\)：
1. 用不同价差 bucket 统计 fill-rate 和 adverse selection。
2. 计算每 bucket 的净收益。
3. 选取稳健区间内收益最大点作为 `base_spread_bps` 初值。

代码落点：
- `strategies/market_making/xgboost_spread.py:_simulate_cost`
- `research/backtest/engine.py:_calculate_fill_probability`
- `research/backtest/engine.py:_apply_slippage`

### 2.4 `inventory_limit` 标定

常用法：按资金损失预算反推。

若币本位组合在极端下跌 \(S\to S(1-d)\) 时，库存风险损失近似不超过日损失预算 \(L\)：
\[
\max_{|q|\le Q} \text{Loss}(q,d) \le L
\Rightarrow Q \le Q^*(L,d,S,\text{contract spec})
\]

工程上用压力回测反推：
1. 固定其他参数。
2. 扫描 `inventory_limit`。
3. 找到满足 `max_drawdown` 和 `daily_loss` 双约束的最大 `Q`。

代码落点：
- `strategies/market_making/integrated_strategy.py::_calculate_quote_sizes`
- `research/risk/circuit_breaker.py:_check_all_limits`

### 2.5 `inventory_skew_factor` 标定

`skew_factor` 太小：去库存慢，尾部库存堆积。
`skew_factor` 太大：报价偏移过度，成交显著下降。

建议目标函数增加库存均值回复速度项：
\[
J_{inv} = -\mathbb{E}[|q_t|] - \beta \cdot \mathbb{E}[\tau_{half}(q)]
\]
其中 \(\tau_{half}\) 表示库存减半时间。

以 `τ_half` 为工程指标，可以比只看 PnL 更早发现库存控制失效。

### 2.6 Hawkes 过程参数标定

Hawkes 做市策略参数在 `HawkesMMConfig` 中定义，分为三类：

#### 2.6.1 过程参数 (\(\mu, \alpha, \beta\))

**基线强度 \(\mu\)**：
- 来源：历史数据订单流到达率估计
- 标定：\(\hat{\mu} = \frac{N_T}{T} \times (1 - \frac{\alpha}{\beta})\)，其中 \(N_T\) 为总事件数
- 重估频率：每日开盘前（固定参数版）或每笔交易（Adaptive 版）
- 约束：\(\mu > 0\)

**激励因子 \(\alpha\)** 与 **衰减率 \(\beta\)**：
- 稳定性条件：\(\alpha < \beta\)（分支比 \(< 1\)）
- 典型取值：
  - 低聚类市场：\(\alpha=0.1, \beta=0.8\)，分支比 \(0.125\)
  - 中聚类市场：\(\alpha=0.4, \beta=0.8\)，分支比 \(0.5\)
  - 高聚类市场：\(\alpha=0.7, \beta=0.8\)，分支比 \(0.875\)
- 在线估计（Adaptive 版）：
```python
# 每 param_update_interval 笔交易更新
mu_new = mu_old + lr * (n_events/dt - intensity_estimate)
alpha_new = alpha_old + lr * (kernel_contribution - alpha_old)
```

#### 2.6.2 价差调整参数

**强度阈值** (`high_intensity_threshold`, `low_intensity_threshold`)：
- 高阈值：\(\lambda > \lambda^* \times 1.5\)（高于长期平均 50%）
- 低阈值：\(\lambda < \lambda^* \times 0.5\)（低于长期平均 50%）
- 标定方法：基于历史强度分布的分位数（75% 和 25%）

**调整因子** (`aggressive_factor`, `defensive_factor`)：
- 激进因子：\(0.3 \sim 0.7\)，高强度时收窄价差
- 防御因子：\(1.5 \sim 3.0\)，低强度时拓宽价差
- 优化目标：在成交率与逆向选择成本间权衡

**库存偏斜因子** (`inventory_skew_factor`)：
- 范围：\(0.1 \sim 1.0\)
- 标定：通过仿真实验找到使库存均值回复速度最优的值
- 注意：与 AS 模型的 \(\gamma\) 有耦合，避免双重惩罚

#### 2.6.3 逆向选择检测参数

**检测阈值** (`adverse_selection_threshold`)：
- 单位：标准差倍数
- 建议：\(2.0 \sim 3.0\)（对应 95% 和 99.7% 置信水平）
- 标定：基于历史有毒订单流的回测准确率优化

**估计窗口** (`estimation_window`)：
- 范围：50 ~ 200 笔交易
- 权衡：窗口太小估计不稳定，太大响应滞后

#### 2.6.4 参数标定工作流

1. **离线预标定**：
   - 使用 3-6 个月历史数据拟合 \(\mu, \alpha, \beta\)
   - 网格搜索价差调整因子和库存偏斜因子
   - 在合成 Hawkes 数据上验证（不同分支比）

2. **在线自适应**（Adaptive 版本）：
   - 设置参数更新间隔（默认 50 笔交易）
   - 监控参数漂移（\(\alpha\) 或 \(\beta\) 连续 5 次更新方向一致时告警）
   - 设置参数边界保护（防止估计异常导致参数越界）

3. **生产监控**：
   - 强度-价差相关系数（预期为负，若为正需检查）
   - 参数稳定性指标（\(\text{Std}(\alpha_t) / \text{Mean}(\alpha_t) < 0.2\)）
   - 逆向选择检测准确率（目标 > 60%）

---

## 3. 风控参数标定：阈值不是拍脑袋

## 3.1 熔断阈值标定逻辑

`CircuitBreakerConfig` 包含：
1. `daily_loss_limit_pct`
2. `max_drawdown_pct`
3. `position_concentration_limit`
4. `cooldown_period_seconds`

标定原则：
1. 用历史与压力混合样本估计尾部分布。
2. 先定“生存阈值”（不爆仓），再定“业务阈值”（可接受波动）。

### 3.2 日损失阈值推导（简版）

给定日损失容忍 \(L_d\) 与初始资本 \(C_0\)：
\[
\text{daily\_loss\_limit\_pct} = \frac{L_d}{C_0}
\]

warning 阈值建议取 50%-70% 的 limit：
\[
\text{daily\_loss\_warning\_pct} = \rho \cdot \text{daily\_loss\_limit\_pct},
\quad \rho\in[0.5,0.7]
\]

这与 `CircuitBreakerConfig` 默认值结构一致。

### 3.3 回撤阈值与恢复策略

在状态机里，恢复必须满足：
1. cooldown 结束。
2. 最近违规事件间隔超过阈值。

代码实现：
- `research/risk/circuit_breaker.py:_can_recover`
- `research/risk/circuit_breaker.py:_get_recovery_state`

建议：
- 恢复只逐级下降，不允许直接 `HALTED -> NORMAL`。
- 生产中设置“人工确认门”可进一步降低误恢复风险。

### 3.4 VaR/CVaR 标定

`research/risk/var.py` 支持 parametric/historical/MC。

实践建议：
1. 短窗口控敏感：historical。
2. 常规门控：parametric。
3. 非线性组合复核：MC + Greeks。

在生产中可用双阈值：
- 预警阈值：\(\mathrm{VaR}_{95}\)
- 强制限制阈值：\(\mathrm{VaR}_{99}\)

---

## 4. 对冲与状态检测参数标定

## 4.1 自适应对冲参数

关键参数在 `AdaptiveHedgeConfig`：
1. `base_hedge_interval_minutes`
2. `price_drop_threshold_pct`
3. `hedge_frequency_multiplier`
4. `gamma_threshold`
5. `max_hedge_size_pct`

标定目标：
1. 控制组合 delta 偏离。
2. 避免过度对冲导致交易成本爆炸。

建议双目标：
\[
\min \; \mathbb{E}[|\Delta_t|] + \lambda_h \mathbb{E}[\text{HedgeCost}_t]
\]

### 4.2 状态检测参数

标准版 `RegimeConfig` 和 fast 版 `FastRegimeConfig` 的核心参数：
1. lookback window
2. retrain interval
3. spread multipliers
4. timeout/fallback

标定要点：
1. `spread_multipliers` 是策略收益曲线形状控制器。
2. fast 版要同时优化两目标：
- regime 识别有效性
- `fallback_ratio` 不过高

建议在线监控：
- `hmm_ratio`
- `fallback_ratio`
- `current_regime` 持续时间

对应函数：
- `research/signals/fast_regime_detector.py:get_stats`

### 4.3 快版缓存参数

`FastIntegratedStrategyConfig` 中：
1. `greeks_cache_ttl_ms`
2. `greeks_cache_max_entries`

标定原则：
1. TTL 太长：过期风险增大。
2. TTL 太短：命中率过低、性能无收益。

建议通过实验确定“拐点区间”：
1. 扫描 TTL：[20, 50, 100, 200, 500] ms。
2. 记录命中率与 P95 latency。
3. 选取 latency 明显改善且策略指标不显著下降的最小 TTL。

---

## 5. 标定算法：从离线到在线

## 5.1 分阶段标定法

建议按三阶段：
1. 阶段 A（离线粗标）：
- 网格搜索 + 压力测试过滤不安全区域。
2. 阶段 B（滚动精标）：
- walk-forward 训练/验证。
3. 阶段 C（在线微调）：
- 小步长调整，不跨越安全边界。

### 5.2 网格 + 约束优化

定义约束：
\[
\text{MaxDD}(\theta) \le d_{max},
\quad
\text{DailyLoss}(\theta) \le l_{max},
\quad
\text{P95Latency}(\theta) \le t_{max}
\]

在可行域内最大化：
\[
\max_{\theta\in\Omega} \text{Sharpe}(\theta) + w_1\text{PnL}(\theta)-w_2\text{Turnover}(\theta)
\]

这比单一 Sharpe 更符合实盘。

### 5.3 Walk-forward 标定模板

建议窗口：
1. Train 60 天
2. Validate 20 天
3. Test 20 天
4. 滚动步长 20 天

每窗口输出：
1. 参数集合
2. 核心指标
3. 是否触发熔断
4. 压力测试结果

### 5.4 鲁棒统计

建议对收益指标做稳健估计：
1. 中位数收益。
2. 分位数 Sharpe（如 25% 分位）。
3. winsorized mean。

目标：避免单个极端窗口把参数推向不可泛化区域。

### 5.5 在线微调与保护栏

在线微调规则建议：
1. 单次变更不超过 10%。
2. 每日最多一次核心参数变更。
3. 任一风险指标恶化超过阈值自动回滚。

---

## 6. 配置管理与参数版本化

## 6.1 配置源

当前代码里的配置来源：
1. Python dataclass 默认值。
2. `.env` / `.env.prod`。
3. 部署描述（Compose/K8s）。

建议统一原则：
1. 交易关键参数与风险阈值必须可追溯版本号。
2. 生产环境不允许“临时手改且无记录”。

### 6.2 建议的参数包结构

示例（建议）：
```yaml
profile: production
version: 2026-02-09.1
strategy:
  base_spread_bps: 20
  gamma: 0.1
  inventory_limit: 10
risk:
  daily_loss_limit_pct: 0.05
  max_drawdown_pct: 0.10
hedge:
  base_hedge_interval_minutes: 30
  gamma_threshold: 0.01
runtime:
  greeks_cache_ttl_ms: 100
  max_quote_latency_ms: 100
```

### 6.3 变更审批等级

建议按风险分级：
1. P0 参数（高风险）：`daily_loss_limit_pct`、`max_drawdown_pct`、`inventory_limit`。
2. P1 参数（中风险）：`base_spread_bps`、`gamma`、对冲阈值。
3. P2 参数（低风险）：日志级别、可观测性采样率。

变更流程：
1. 提案
2. 回测与压力证明
3. 预生产验证
4. 生产灰度
5. 回滚预案确认

---

## 6.4 Hawkes 对比实验框架使用指南

`research/backtest/hawkes_comparison.py` 提供标准化的策略对比实验能力。

### 6.4.1 适用场景

1. **新策略上线前验证**：对比 Hawkes 策略与现有基准策略
2. **参数调优后回归验证**：确保参数调整未引入性能退化
3. **市场环境变化评估**：验证策略在新市场条件下的相对优势
4. **自适应机制效果评估**：对比固定参数与 Adaptive 版本

### 6.4.2 实验配置模板

```yaml
# hawkes_experiment_config.yaml
experiment:
  name: "hawkes_vs_baseline_q1_2024"
  description: "Hawkes策略与AS/ML策略的季度对比实验"

scenarios:
  synthetic:
    enabled: true
    cluster_levels: [low, medium, high, critical]
    base_price: 50000.0
    price_volatility: 0.02

  stress:
    enabled: true
    types: [volume_spike, liquidity_drought, inventory_stress]

strategies:
  - name: "HawkesFixed"
    class: "strategies.market_making.hawkes_mm.HawkesMarketMaker"
    config: "config/hawkes_default.yaml"

  - name: "HawkesAdaptive"
    class: "strategies.market_making.hawkes_mm.AdaptiveHawkesMarketMaker"
    config: "config/hawkes_adaptive.yaml"

  - name: "AvellanedaStoikov"
    class: "strategies.market_making.avellaneda_stoikov.AvellanedaStoikov"
    config: "config/as_default.yaml"

  - name: "Naive"
    class: "strategies.market_making.naive.NaiveMarketMaker"
    config: "config/naive_default.yaml"

metrics:
  primary: [sharpe_ratio, total_pnl, max_drawdown]
  hawkes_specific:
    - intensity_spread_correlation
    - parameter_stability
    - adverse_selection_accuracy

reporting:
  output_dir: "results/hawkes_experiment_q1_2024"
  generate_charts: true
  statistical_tests: true
```

### 6.4.3 执行流程

```python
# run_hawkes_experiment.py
from research.backtest.hawkes_comparison import (
    ScenarioGenerator,
    ComprehensiveHawkesComparison
)
import yaml

def main():
    # 加载配置
    with open('hawkes_experiment_config.yaml') as f:
        config = yaml.safe_load(f)

    # 生成场景
    gen = ScenarioGenerator(
        base_price=config['scenarios']['synthetic']['base_price']
    )
    scenarios = {}

    if config['scenarios']['synthetic']['enabled']:
        scenarios.update(gen.generate_hawkes_scenarios())

    if config['scenarios']['stress']['enabled']:
        scenarios.update(gen.generate_stress_scenarios())

    # 初始化策略
    strategies = []
    for strat_config in config['strategies']:
        strategy = load_strategy(strat_config)  # 策略工厂函数
        strategies.append(strategy)

    # 运行对比
    comparison = ComprehensiveHawkesComparison(
        initial_capital=100000.0,
        transaction_cost_bps=2.0
    )

    results = comparison.run_full_comparison(
        strategies=strategies,
        scenarios=scenarios,
        verbose=True
    )

    # 生成报告
    report = comparison.generate_summary_report()

    output_dir = config['reporting']['output_dir']
    os.makedirs(output_dir, exist_ok=True)

    with open(f'{output_dir}/report.md', 'w') as f:
        f.write(report)

    # 保存详细数据
    df = comparison.get_comparison_dataframe()
    df.to_csv(f'{output_dir}/results.csv', index=False)

    print(f"实验完成。报告保存在: {output_dir}/report.md")

if __name__ == '__main__':
    main()
```

### 6.4.4 结果解读与决策

**统计显著性判断：**

```python
# Welch's t-test 结果解读
from scipy import stats

# 假设比较 Hawkes vs AS 的 Sharpe 比率
hawkes_sharpes = results['high_clustering'].scorecards['HawkesFixed'].pnl_series.diff()
as_sharpes = results['high_clustering'].scorecards['AvellanedaStoikov'].pnl_series.diff()

t_stat, p_value = stats.ttest_ind(hawkes_sharpes, as_sharpes, equal_var=False)

if p_value < 0.05 and t_stat > 0:
    print("Hawkes 策略在高聚类场景中显著优于 AS (p < 0.05)")
elif p_value < 0.05 and t_stat < 0:
    print("AS 策略显著优于 Hawkes，需检查 Hawkes 参数配置")
else:
    print("差异不显著，可能需要更多数据或调整实验设计")
```

**Hawkes 专项指标检查清单：**

| 指标 | 预期值 | 异常判断 | 行动建议 |
|------|--------|----------|----------|
| 强度-价差相关系数 | < -0.1 | > 0（正相关） | 检查价差调整逻辑 |
| 参数稳定性 | > 0.8 | < 0.5 | 增加估计窗口或降低学习率 |
| 逆向选择准确率 | > 0.6 | < 0.5 | 调整检测阈值或改进特征 |
| 高聚类场景 Sharpe | > 基准 20% | < 基准 | 重新标定 α, β 参数 |

### 6.4.5 集成到 CI/CD

在 `.github/workflows/ci.yml` 中添加：

```yaml
- name: Run Hawkes Comparison Regression
  run: |
    python run_hawkes_experiment.py \
      --config config/ci_hawkes_experiment.yaml \
      --quick-mode  # 使用缩短的时间范围

- name: Check Regression Thresholds
  run: |
    python scripts/check_hawkes_regression.py \
      --results results/hawkes_ci/ \
      --thresholds config/hawkes_thresholds.yaml
```

### 6.4.6 Jupyter Notebook 交互式分析

```bash
jupyter notebook notebooks/06_hawkes_backtest_comparison.ipynb
```

Notebook 提供：
- 交互式参数滑块（实时调整 α, β, μ 观察效果）
- 可视化对比图表（PnL、回撤、风险-收益散点）
- 场景分解分析（不同聚类程度的独立视图）
- 参数敏感性热力图

---

## 7. 实盘部署架构：从容器到集群

## 7.1 服务拆分

代码中已拆分三个入口：
1. `execution/trading_engine.py`
2. `execution/risk_monitor.py`
3. `execution/market_data_collector.py`

共同运行底座：
- `execution/service_runner.py:run_service`
- `core/health_server.py`

这是“职责分离”架构：
- 交易决策、风险监控、数据采集分离，降低单点故障影响面。

### 7.2 容器化路径

开发容器：
- `Dockerfile`
- `docker-compose.yml`

生产容器：
- `deployment/Dockerfile.prod`
- `deployment/docker-compose.prod.yml`

生产要点：
1. 多阶段构建。
2. 非 root 用户。
3. 健康检查。
4. 资源限额。

### 7.3 K8s 路径

关键清单：
- `deployment/k8s/trading-engine.yaml`

已包含：
1. RollingUpdate 策略。
2. liveness/readiness 探针。
3. HPA 自动扩缩容。
4. PDB 可用性保障。

### 7.4 健康检查语义

`core/health_server.py` 定义：
1. `/health`：存活检查（liveness）。
2. `/ready`：就绪检查（readiness）。
3. `/metrics`：基础指标出口。

建议：
1. liveness 保守，只测进程基本可用。
2. readiness 严格，必须覆盖关键依赖可用性。

---

## 8. 发布策略：灰度、门禁、回滚

## 8.1 三环境建议

1. Dev：功能开发与单元测试。
2. Staging：准生产流量与依赖，做集成与演练。
3. Production：真实流量。

### 8.2 发布门禁（Go/No-Go）

建议门禁必须同时满足：
1. 单元 + 集成 + 回归通过。
2. 性能基准通过（P95 不退化）。
3. 压力测试通过。
4. 安全扫描通过。
5. 回滚脚本可用且已演练。

项目现有门禁参考：
- `.github/workflows/ci.yml`
- `verify_all.sh`
- `Makefile` 的 `quality` 与 `test-cov`

### 8.3 灰度发布模板

建议步骤：
1. 先部署 10% 实例。
2. 观察 30-60 分钟关键指标。
3. 无异常扩到 50%。
4. 再全量。

关键监控窗口：
1. 报价延迟。
2. 熔断状态。
3. 错误率。
4. PnL 偏离。
5. fallback ratio。

### 8.4 回滚策略

触发条件示例：
1. P95 latency 超标连续 5 分钟。
2. `HALTED` 触发异常频繁。
3. 关键错误率超阈值。
4. 交易行为偏离安全包络。

执行路径：
1. 停止新版本实例。
2. 切回上个稳定参数包 + 镜像。
3. 验证 `/health` 与 `/ready`。
4. 复盘根因并冻结重发版。

`deployment/scripts/deploy.sh` 已具备基础回滚逻辑（trap ERR）。

---

## 9. 运行时监控：SLI/SLO 设计

## 9.1 SLI 分层

建议至少监控 5 类 SLI：
1. 交易性能：quote latency、risk check latency。
2. 稳定性：服务可用率、重连次数、异常率。
3. 风险状态：熔断状态分布、违规计数。
4. 策略行为：spread、inventory、hedge 触发率。
5. 业务结果：PnL、drawdown、adverse selection。

### 9.2 SLO 示例

可落地 SLO（示例）：
1. `Quote P95 < 35ms`（fast 路径）。
2. `Risk check P95 < 10ms`。
3. `Service availability >= 99.9%`。
4. `HALTED state duration < 0.5%` 的交易时长。

### 9.3 指标映射到代码

建议从 metadata 和状态对象直接埋点：
1. `strategies/market_making/integrated_strategy.py:quote` 的 metadata。
2. `strategies/market_making/fast_integrated_strategy.py:get_performance_stats`。
3. `research/risk/circuit_breaker.py:get_status`。
4. `research/signals/fast_regime_detector.py:get_stats`。
5. `strategies/market_making/hawkes_mm.py:get_internal_state`（Hawkes 专项）。

### 9.3.1 Hawkes 策略专项监控

使用 Hawkes 策略时，必须额外监控：

**强度指标：**
- `hawkes_intensity_current`: 当前 Hawkes 强度 λ(t)
- `hawkes_intensity_buy`: 买单方向强度
- `hawkes_intensity_sell`: 卖单方向强度
- `hawkes_branching_ratio`: 分支比 α/β

**参数稳定性（Adaptive 版本）：**
- `hawkes_param_mu`: 基线强度估计值
- `hawkes_param_alpha`: 激励因子估计值
- `hawkes_param_beta`: 衰减率估计值
- `hawkes_param_update_count`: 参数更新次数
- `hawkes_param_stability_score`: 参数稳定性评分 (0-1)

**价差调整效果：**
- `hawkes_spread_adjustment_factor`: 当前价差调整因子
- `hawkes_intensity_spread_correlation`: 强度-价差相关系数（滑动窗口）
- `hawkes_skew_adjustment_bps`: 库存偏斜调整量

**逆向选择检测：**
- `hawkes_adverse_detected_count`: 检测到逆向选择次数
- `hawkes_adverse_accuracy`: 检测准确率（若有标签反馈）
- `hawkes_adverse_cost_avoided`: 避免的逆向选择成本（估计）

**代码埋点示例：**
```python
# strategies/market_making/hawkes_mm.py
from prometheus_client import Gauge, Counter, Histogram

# 定义指标
HAWKES_INTENSITY = Gauge('hawkes_intensity_current', 'Current Hawkes intensity', ['side'])
HAWKES_PARAM = Gauge('hawkes_param', 'Hawkes parameter estimate', ['param_name'])
HAWKES_SPREAD_ADJ = Gauge('hawkes_spread_adjustment', 'Spread adjustment factor')
ADVERSE_DETECTED = Counter('hawkes_adverse_detected', 'Adverse selection detected')

class HawkesMarketMaker:
    def quote(self, state, position):
        # ... 原有逻辑 ...

        # 埋点
        HAWKES_INTENSITY.labels(side='buy').set(self.monitor.buy_intensity)
        HAWKES_INTENSITY.labels(side='sell').set(self.monitor.sell_intensity)
        HAWKES_SPREAD_ADJ.set(adjustment_factor)

        if is_adverse:
            ADVERSE_DETECTED.inc()

        return quote
```

**SLO 建议（Hawkes 专项）：**
- `|intensity_spread_correlation + 0.3| < 0.5`（确保负相关且显著）
- `param_stability_score > 0.8`（Adaptive 版本参数稳定）
- `adverse_accuracy > 0.6`（检测有效）

### 9.4 Prometheus 抓取

已配置：
- `deployment/config/prometheus.yml`

抓取目标：
1. `trading-engine:8080/metrics`
2. `risk-monitor:8080/metrics`
3. `market-data:8080/metrics`

建议完善：
1. 把 `/metrics` 从占位信息升级为真实指标导出。
2. 标准化 metric name 与 labels。

---

## 10. 告警体系：分级、抑制与升级路径

## 10.1 告警分级建议

1. P0（立即中断业务风险）：
- 资金风险失控、系统不可用。
2. P1（高风险异常）：
- 熔断频繁触发、延迟持续高企。
3. P2（可恢复异常）：
- 单服务重连频繁、缓存命中下滑。
4. P3（优化类）：
- 指标趋势恶化但未越阈。

### 10.2 告警规则建议（样例）

PromQL 思路：
1. 延迟告警：
- `histogram_quantile(0.95, rate(quote_latency_bucket[5m])) > threshold`
2. 风险告警：
- `circuit_breaker_state != NORMAL`
3. 可用性告警：
- `up == 0`
4. Hawkes 专项告警：
- 强度-价差正相关（策略逻辑异常）：`hawkes_intensity_spread_correlation > 0`
- 参数不稳定（Adaptive 版本）：`hawkes_param_stability_score < 0.5`
- 逆向选择检测失效：`hawkes_adverse_accuracy < 0.4`
- 分支比接近临界：`hawkes_branching_ratio > 0.95`

### 10.3 抑制与去噪

避免“告警风暴”建议：
1. 同源告警做聚合。
2. 使用 `for: 2m/5m` 抑制瞬时尖峰。
3. 上游故障触发时抑制下游衍生告警。

### 10.4 升级路径

建议值班流程：
1. 5 分钟内确认告警真实性。
2. 15 分钟内完成初步隔离（降级或回滚）。
3. 30 分钟内明确根因方向。
4. 24 小时内完成复盘文档。

---

## 11. 故障演练体系：可复制的 runbook

## 11.1 演练原则

1. 演练要“可注入、可观测、可回收”。
2. 每次演练必须有成功判据。
3. 先在 staging 演练，验证通过再小流量生产演练。

### 11.2 演练剧本 A：WebSocket 中断与重连退化

注入方式：
1. 人工断开市场数据网络。
2. 或阻断到交易所 WS 域名。

观察点：
1. `data/streaming.py` 重连次数。
2. reconnect backoff 是否生效。
3. 业务是否进入安全降级（减少/停止报价）。

成功判据：
1. 在 `max_reconnects` 内恢复，或安全停机。
2. 不出现未捕获异常导致进程退出。

### 11.3 演练剧本 B：Redis 故障

注入方式：
1. 停止 Redis 实例。
2. 模拟网络超时。

观察点：
1. `IntegratedDataManager.connect` 是否优雅降级。
2. 策略是否在无 Redis 下继续运行（功能降级可接受）。
3. 告警是否正确触发。

成功判据：
1. 系统不崩溃。
2. 核心报价链路可用。
3. 恢复 Redis 后自动恢复缓存功能。

### 11.4 演练剧本 C：数据库不可用

注入方式：
1. 停止 Postgres。
2. 注入高延迟。

观察点：
1. 非关键路径是否阻塞关键报价路径。
2. 监控与日志是否明确报告失败点。

成功判据：
1. 关键交易路径不被 DB 阻塞。
2. 数据落库失败进入重试或补偿机制。

### 11.5 演练剧本 D：极端行情（闪崩）

注入方式：
1. 使用 `tests/performance/stress_test.py` 的闪崩场景。
2. 或回放历史极端行情样本。

观察点：
1. 熔断状态转移轨迹。
2. 对冲触发频率与对冲量。
3. 最大库存和 drawdown。

成功判据：
1. 风险限制触发符合预期。
2. 无失控加仓或无限循环。

### 11.6 演练剧本 E：延迟飙升

注入方式：
1. 增加 CPU 压力。
2. 人工放大 I/O 等待。

观察点：
1. `quote_latency` P95/P99。
2. fast/standard 策略降级路径。
3. 告警触发和自动回滚动作。

成功判据：
1. 触发阈值后能自动降级或回滚。
2. 恢复后指标回归目标区间。

### 11.7 演练剧本 F：Hawkes 参数漂移与失效

适用场景：使用 Hawkes 做市策略（尤其是 Adaptive 版本）时。

注入方式：
1. **参数漂移注入**：
```python
# 在测试中临时修改参数更新逻辑
def mock_param_update(self):
    # 人为引入参数漂移
    self.mu *= 1.5  # 基线强度异常增加
    self.alpha = 0.95  # 接近临界值
    self.beta = 1.0    # 分支比 0.95，接近不稳定
```

2. **市场结构突变**：
   - 从低聚类参数突然切换到高聚类市场数据
   - 使用 `ScenarioGenerator` 生成 critical 场景数据

3. **估计窗口污染**：
   - 在估计窗口中注入异常大单
   - 模拟快闪式交易（flash trading）

观察点：
1. **参数稳定性监控**：
   - `hawkes_param_stability_score` 是否下降
   - `hawkes_branching_ratio` 是否接近 1.0
   - 参数更新频率是否异常

2. **价差调整效果**：
   - `hawkes_intensity_spread_correlation` 是否变为正相关
   - `hawkes_spread_adjustment_factor` 是否在边界值（min/max）徘徊

3. **业务指标影响**：
   - 成交率是否显著下降
   - 逆向选择成本是否上升
   - 库存是否异常累积

4. **降级与恢复**：
   - Adaptive 版本是否切换到固定参数备份
   - 告警是否正确触发（P1/P2）
   - 人工干预后是否能恢复正常

成功判据：
1. 参数漂移被检测并在 30 秒内触发告警。
2. 策略进入安全模式（使用保守固定参数）。
3. 业务指标（成交率、库存）不出现不可逆恶化。
4. 人工干预后，系统能在 5 分钟内恢复正常参数估计。

演练检查清单：
- [ ] 已备份正常参数配置
- [ ] 告警规则已启用（分支比 > 0.95，稳定性 < 0.5）
- [ ] 降级路径已验证（Adaptive → Fixed）
- [ ] 值班人员知晓干预步骤
- [ ] 演练数据已准备（critical 场景）

---

## 12. 生产运行 Playbook（值班手册）

## 12.1 每日开盘前检查

1. 服务状态：
- `trading-engine`、`risk-monitor`、`market-data` 全部健康。

2. 风险状态：
- circuit breaker 为 `NORMAL`。
- 无未处理 critical 告警。

3. 数据状态：
- WS 连接稳定。
- 缓存命中率在历史区间。

4. 参数版本：
- 今日参数包与审批记录一致。

### 12.2 盘中巡检节奏

建议每 30 分钟巡检：
1. latency 趋势。
2. inventory 偏离。
3. spread 漂移。
4. 熔断与违规日志。
5. PnL 与回撤。

### 12.3 日终检查

1. 导出当日关键指标。
2. 对比昨日与 7 日均值。
3. 记录异常与临时操作。
4. 生成次日参数调整候选清单。

---

## 13. 参数重估与再训练策略

## 13.1 重估触发条件

建议触发重估的条件：
1. regime 分布显著变化。
2. fill-rate 与历史基线偏离超过阈值。
3. adverse selection 成本显著上升。
4. fallback ratio 持续高位。

### 13.2 重估频率建议

1. 高频参数（运行时）：日更或半日更。
2. 中频参数（策略控制）：周更。
3. 低频参数（风控硬阈值）：月更或重大事件后重估。

### 13.3 再训练门禁

ML/RL 策略再训练必须满足：
1. 训练数据窗口不含未来泄漏。
2. 外样本稳定优于当前生产版本。
3. 通过压力场景回归。
4. 再训练模型带版本号与可回滚模型快照。

---

## 14. 测试与验证矩阵（上线前必过）

## 14.1 单元与集成

关键模块必须覆盖：
1. 风控状态机。
2. 对冲决策。
3. 状态检测。
4. 综合策略 quote 主流程。

项目已有参考：
- `tests/test_circuit_breaker.py`
- `tests/test_adaptive_hedging.py`
- `tests/test_regime_detector.py`
- `tests/test_integrated_strategy.py`

### 14.2 性能回归

使用：
- `tests/performance/latency_benchmark.py`
- `tests/performance/stress_test.py`

建议验收：
1. Quote P95 达标。
2. 风险检查 P95 达标。
3. 压测下错误率可控。

### 14.3 全量验证脚本

可参考：
- `verify_all.sh`

建议把它纳入发布流水线，在 staging 作为硬门禁。

### 14.4 CI 门禁

当前 `.github/workflows/ci.yml` 已含：
1. `ruff`
2. `black --check`
3. `mypy`（核心模块）
4. `pytest + coverage`
5. 性能回归 guard（Python 3.11）

建议补充：
1. 部署清单语法验证（compose/k8s）。
2. 安全策略扫描结果阈值化。

---

## 15. 监控与告警面板设计（建议）

## 15.1 面板 A：交易总览

核心图表：
1. quote latency P50/P95/P99。
2. quote count / fill count。
3. spread bps 分布。
4. inventory 时序。

### 15.2 面板 B：风险总览

核心图表：
1. circuit state timeline。
2. violation count by type。
3. drawdown 与 daily PnL。
4. VaR/CVaR 曲线。

### 15.3 面板 C：运行健康

核心图表：
1. WS reconnect 次数。
2. Redis health。
3. Postgres latency。
4. CPU/memory/IO。

### 15.4 面板 D：策略质量

核心图表：
1. adverse selection cost。
2. inventory half-life。
3. hedger trigger rate。
4. regime fallback ratio。

---

## 16. 事故处理模板（值班直接可用）

## 16.1 事故记录头

模板：
```markdown
# Incident Report
- 时间：
- 等级：P0/P1/P2/P3
- 发现方式：告警/人工
- 影响范围：
- 当前状态：处理中/已恢复
```

### 16.2 处置时间线模板

```markdown
## Timeline
- T0: 告警触发
- T+5m: 值班确认
- T+10m: 临时止血措施
- T+20m: 根因初判
- T+40m: 回滚或修复完成
- T+24h: 复盘完成
```

### 16.3 根因分类

建议统一标签：
1. 数据源异常
2. 参数失配
3. 模型失效
4. 基础设施故障
5. 发布变更缺陷

---

## 17. 上线清单（可直接执行）

## 17.1 D-7（上线前一周）

1. 确定参数包候选。
2. 完成回测与压力回归。
3. 故障演练至少 2 个关键剧本。

### 17.2 D-1（上线前一天）

1. 冻结代码与参数版本。
2. 检查告警通道。
3. 检查回滚镜像与脚本。

### 17.3 D-Day（上线日）

1. 灰度发布 10%。
2. 实时观察核心 SLI。
3. 条件满足后逐步扩量。

### 17.4 D+1（上线后次日）

1. 复盘所有异常日志与告警。
2. 对比预期与实际绩效。
3. 决定是否进入下一轮优化。

---

## 18. 常见反模式与改进建议

1. 反模式：参数靠经验直接改生产。
- 改进：先走离线-预生产-灰度闭环。

2. 反模式：只看平均延迟。
- 改进：重点看 P95/P99 与长尾。

3. 反模式：把风控当事后报表。
- 改进：风控门前置到交易动作可行域。

4. 反模式：告警阈值一刀切。
- 改进：按时段、市场状态分层阈值。

5. 反模式：演练只做“成功路径”。
- 改进：必须包含失败注入与回滚验证。

---

## 19. 建议自动化能力（下一阶段）

可优先建设 6 个自动化：
1. 参数包发布流水线（带审批和审计）。
2. 一键回归实验流水线（回测 + 压力 + 报告）。
3. 灰度发布控制器（按 SLO 自动扩缩）。
4. 自动回滚器（SLO breach 触发）。
5. 夜间巡检机器人（日报 + 异常摘要）。
6. 复盘报告生成器（模板化填充）。

---

## 20. 附录 A：关键文件速查

部署与运行：
1. `execution/service_runner.py`
2. `execution/trading_engine.py`
3. `execution/risk_monitor.py`
4. `execution/market_data_collector.py`
5. `core/health_server.py`

生产部署：
1. `deployment/Dockerfile.prod`
2. `deployment/docker-compose.prod.yml`
3. `deployment/k8s/trading-engine.yaml`
4. `deployment/config/prometheus.yml`
5. `deployment/scripts/deploy.sh`
6. `deployment/sql/init.sql`
7. `deployment/config/.env.prod.template`

标定与性能：
1. `tests/performance/latency_benchmark.py`
2. `tests/performance/stress_test.py`
3. `verify_all.sh`
4. `.github/workflows/ci.yml`

策略与风控核心：
1. `strategies/market_making/integrated_strategy.py`
2. `strategies/market_making/fast_integrated_strategy.py`
3. `research/risk/circuit_breaker.py`
4. `research/hedging/adaptive_delta.py`
5. `research/signals/regime_detector.py`
6. `research/signals/fast_regime_detector.py`
7. `research/risk/var.py`

---

## 21. 附录 B：参数标定实验记录模板

```markdown
# 参数标定实验记录
- 实验编号：
- 日期：
- 数据窗口：
- 策略版本：
- 参数版本：

## 实验目标

## 参数空间

## 约束条件
- MaxDD <=
- DailyLoss <=
- P95Latency <=

## 结果摘要
- Best Param:
- Sharpe:
- PnL:
- MaxDD:
- CVaR:

## 压力测试结果

## 是否进入灰度
- Yes/No
- 理由：
```

---

## 22. 附录 C：故障演练验收模板

```markdown
# 故障演练验收
- 演练日期：
- 演练剧本：
- 环境：staging/production-canary

## 注入方式

## 观测指标
- 触发时间：
- 恢复时间：
- 是否触发回滚：

## 验收结果
- 是否达标：
- 未达标项：

## 改进动作
- owner:
- deadline:
```

---

## 23. 结语：把“策略研究”升级为“可运营系统”

第四册的核心不是再多一个模型，而是建立“可持续运营”的闭环：
1. 参数可解释、可标定、可回滚。
2. 发布可控、故障可演练、风险可前置。
3. 运行可观测、告警可执行、优化可度量。

当你能做到：
1. 每次参数调整都有证据链。
2. 每次上线都有门禁和回滚。
3. 每次故障都能在既定时间内止血并复盘。

项目就从“技术演示”进入“生产系统”阶段。

